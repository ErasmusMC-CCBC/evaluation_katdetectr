---
title: "Analyze performance Alexandrov data"
author: "Daan Hazelaar"
date: '2022-04-22'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
```


```{r}
load(file = "../results/resultsAlexandrovAllTools.RData")
load(file = "../data/alexandrov_data_processed.RData")
load(file = "../data/sampleOrigin.RData")
source(file = "./function_calculateMetrics.R")
source(file = "./function_calculateConfusionVariants.R")
```


Descriptive statistic of the WGS samples in the alexandrov dataset
```{r}
fociPerSample <- alexandrovData$reportedKataegis |> 
    tibble::as_tibble() |> 
    dplyr::group_by(.data$sampleNames) |> 
    dplyr::summarise(
        nKataegisFoci = dplyr::n()
    )

alexandrovData$genomicVariants |>
    tibble::as_tibble() |> 
    dplyr::group_by(.data$sampleNames) |> 
    dplyr::summarise(
        .groups = "keep",
        totalVariants = dplyr::n(),
        kataegisVariants = sum(.data$kataegis),
        tissue = unique(.data$tissue)
    ) |> 
    dplyr::mutate(
        TMB = base::round(.data$totalVariants / 3095, 3),
        TMBcat = dplyr::case_when(
            TMB < 1 ~ "low",
            TMB >= 1 & TMB < 10 ~ "mid",
            TMB >= 10 ~ "high"
        )
    ) |> 
    dplyr::left_join(fociPerSample, by = "sampleNames") |> 
    dplyr::mutate(nKataegisFoci = tidyr::replace_na(.data$nKataegisFoci, 0)) |> 
    dplyr::group_by(TMBcat) |> 
    dplyr::summarise(
        nSample = dplyr::n(),
        nKataegisSamples = base::sum(.data$nKataegisFoci != 0),
        totalVariants = base::sum(.data$totalVariants),
        kataegisVariants = base::sum(.data$kataegisVariants),
        nKataegisFoci = base::sum(.data$nKataegisFoci)
    )
```

put all results in a single dataframe and add columns needed for further analysis
```{r}
kataegisSampleNames <- base::unique(alexandrovData$reportedKataegisFoci$sampleNames)
nVariantsInSample <- base::lapply(alexandrovData$genomicVariants, base::length)
nVariantsInSampleTib <- tibble::tibble(sampleNames = base::names(nVariantsInSample), totalVariantsInSample = base::unlist(nVariantsInSample))

# combine all results in a single tibble and add columns needed for subsequent analysis
resultsAlex <- dplyr::bind_rows( 
    "MafTools" = resultsAlexandrovAllTools$maftools, 
    "SeqKat" = resultsAlexandrovAllTools$seqkat,
    "ClusteredMutations" = resultsAlexandrovAllTools$clusteredMutations,
    "katdetectr" = resultsAlexandrovAllTools$katdetectr,
    "kataegis" = resultsAlexandrovAllTools$kataegis,
    "SigProfilerClusters" = resultsAlexandrovAllTools$sigProfilerClusters,
    .id = "package") |> 
    dplyr::distinct() |> 
    dplyr::left_join(nVariantsInSampleTib, by = "sampleNames") |> 
    dplyr::mutate(
        # calculate tumor mutational burden per sample by total number of variants / (length of the genome / 10^6) ~ 3095
        TMB = base::round(totalVariantsInSample / 3095, 3),
        TMBcat = dplyr::case_when(
            TMB < 1 ~ "low",
            TMB >= 1 & TMB < 10 ~ "mid",
            TMB >= 10 ~ "high"
        ),
        TMBcat = factor(TMBcat, levels = c("high", "mid", "low")),
        # specify if a kataegis foci was detected by the method
        detectedKataegisInSample = dplyr::if_else(is.na(.data$totalVariants), FALSE, TRUE),
        # specify if a sample contains a kataegis foci according to Alexandrov
        kataegisInSample = dplyr::if_else(sampleNames %in% kataegisSampleNames, TRUE, FALSE)
    ) |> 
    dplyr::left_join(sampleOrigin, by = "sampleNames")
```

Calculate the performance of the kataegis detection tools regarding sample classfication
```{r}
resultsPerSample <- resultsAlex |> 
    # summarise if a method detected kataegis in a sample
    dplyr::group_by(.data$package, .data$sampleNames, .data$TMB, .data$TMBcat, .data$runTime) |> 
    dplyr::summarise(
        .groups = "keep",
        # is a kataegis foci detected by the method
        detectedKataegisInSample = any(detectedKataegisInSample),
        # is there actualy a kataegis foci in that sample
        kataegisInSample = any(kataegisInSample)
    ) |> 
    dplyr::ungroup() |> 
    dplyr::rowwise() |> 
    # calculate confusion matrix
    dplyr::mutate(
        TP = .data$detectedKataegisInSample == TRUE & .data$kataegisInSample == TRUE,
        FP = .data$detectedKataegisInSample == TRUE & .data$kataegisInSample == FALSE,
        TN = .data$detectedKataegisInSample == FALSE & .data$kataegisInSample == FALSE,
        FN = .data$detectedKataegisInSample == FALSE & .data$kataegisInSample == TRUE
    ) |> 
    dplyr::ungroup()

performancePerSample <- resultsPerSample |> 
    dplyr::group_by(.data$package) |> 
    dplyr::group_modify(~ calculateMetrics(.x), .keep = TRUE) |> 
    dplyr::ungroup()

performancePerSampleTMB <- resultsPerSample |> 
    dplyr::group_by(.data$package, .data$TMBcat) |> 
    dplyr::group_modify(~ calculateMetrics(.x), .keep = TRUE) |> 
    dplyr::ungroup()
```

Calculate the performance of the kataegis detection tools regarding variant classification
```{r}
resultsPerVariant <- resultsAlex |>
    dplyr::group_by(.data$package, .data$sampleNames) |> 
    dplyr::group_modify(~ calculateConfusionVariants(.x, variantData = alexandrovData), keep = TRUE) |> 
    dplyr::ungroup()

performancePerVariant <- resultsPerVariant |> 
    dplyr::group_by(.data$package) |> 
    dplyr::group_modify(~ calculateMetrics(.x), keep = TRUE) |> 
    dplyr::ungroup() |> 
    arrange(desc(nMCC)) |> 
    dplyr::select(package, accuracy, nMCC, F1, TPR, TNR)

performancePerVariantTMB <- resultsPerVariant |> 
    dplyr::group_by(.data$package, .data$TMBcat) |> 
    dplyr::group_modify(~ calculateMetrics(.x), keep = TRUE) |> 
    dplyr::ungroup()
```

Plot nMCC as a function of the TMB for each packge
```{r}
levelOrderTMB <- c("Low (TMB < 0.1)", "Mid (0.1 >= TMB < 10)", "High (TMB >= 10)")
levelOrderTMB <- c("low", "mid", "high")
levelOrderPackages <- factor(performancePerVariant$package, levels = arrange(performancePerVariant, nMCC)$package)

plotLinenMCCperTMB <- performancePerVariantTMB |> 
    ggplot2::ggplot(aes(
        x = factor(TMBcat, levels = levelOrderTMB), 
        y = nMCC, 
        group = factor(package, levels = levelOrderPackages), 
        colour = factor(package, levels = levelOrderPackages))) +
    geom_line(size = 0.8, alpha = 0.4) +
    geom_point(aes(x = factor(TMBcat, levels = levelOrderTMB), y = nMCC)) +
    theme_light() +   
    scale_colour_discrete("Package") +
    scale_x_discrete(labels=c("low" = "Low (TMB < 0.1)\n n = 301", 
                              "mid" = "Mid (0.1 ≥ TMB < 10)\n n = 186",
                              "high" = "High (TMB ≥ 10)\n n = 20")) +
    ylim(0.5, 1) +
    xlab("TMB class") +
    ggtitle("Performance on Alexandrov data")
#theme(legend.position="none")

ggsave(file = "../../katdetectr_manusscript/figures/plotAlexandrovLinenMCCperTMB.jpeg", plotLinenMCCperTMB, width = 7, height = 3)
```



plot performance in variant classification split on TMB
```{r}
# facet labels
TMB.labs <- c("TMB >= 10", "0.1 >= TMB < 10", "TMB < 0.1")
names(TMB.labs) <- c("high", "mid", "low")

plotPerformancePerVariantTMB <- performancePerVariantTMB |> 
    tidyr::pivot_longer(
        cols = c(accuracy, TPR, TNR, F1, nMCC),
        names_to = "performanceMetric",
        values_to = "value"
    ) |> 
    ggplot2::ggplot(aes(y = factor(package, levels = arrange(performancePerVariant, nMCC)$package), 
                        x = factor(performanceMetric, levels = c("accuracy","nMCC", "F1", "TPR", "TNR")), 
                        label = round(value, 4), 
                        fill = value)) +
    ggplot2::geom_tile(color = 'grey25') +
    scale_fill_gradientn(colors = hcl.colors(20, "RdYlGn"), values = c(0,0.5,1)) +
    ggplot2::ylab("Package") +
    ggplot2::xlab("Performance on Alexandrov et al. data split on TMB") +
    scale_x_discrete(position = "top") +
    theme(
        axis.text.x = element_text(angle = 0, ),
        text = ggplot2::element_text(size=10, family='Helvetica'),
        strip.background = ggplot2::element_blank(),
        panel.background = element_blank(),
        legend.title = element_blank()
    ) +
    ggplot2::geom_text(size = 2.9, angle = 0) +
    facet_grid(TMBcat~., labeller = labeller(TMBcat = TMB.labs)) 

ggsave(file = "../../katdetectr_manusscript/figures/plotAlexandrovDataPerformancePerVariantTMB.jpeg", plotPerformancePerVariantTMB, height = 5, width = 5.9)
```

```{r}
# facet labels
detectedKataegisInSample.labs <- c("Kataegis Samples", "Non Kataegis Samples")
names(detectedKataegisInSample.labs) <- c(TRUE, FALSE)

# Total runtimes of all PCF methods 
plotRunTimesTotal <- resultsPerSample |> 
    ggplot(mapping = aes(x = factor(package, levels = arrange(performancePerSample, meanRuntime)$package), y = runTime/60)) + 
    geom_boxplot(outlier.size = 0.5) +
    ggplot2::ylab("Run times (minutes)") +
    ggplot2::xlab("Package name") +
    ggtitle("Total runtimes of kataegis detection tools Alexandrov dataset")  +
    theme_light() +
    theme(axis.text.x = element_text( size = 10))


ggsave(file = "../../katdetectr_manusscript/figures/plotAlexandrovRuntimesTotal.jpeg", plotRunTimesTotal, width = 12, height = 4)

plotRunTimesTotallog10 <- resultsPerSample |> 
    ggplot(mapping = aes(x = factor(package, levels = arrange(performancePerSample, meanRuntime)$package), y = runTime/60)) + 
    geom_boxplot(outlier.size = 0.5) +
    ggplot2::ylab("Run times (minutes)") +
    ggplot2::xlab("Package name") +
    ggtitle("Total runtimes of kataegis detection tools Alexandrov dataset log10 scale")  +
    theme_light() +
    theme(axis.text.x = element_text(size = 10)) +
    ylim(0, 15) + 
    scale_y_log10(breaks = c(0, 0.01, 0.1, 1, 5, 10, 15), labels = c(0, 0.01, 0.1, 1, 5, 10, 15)) +
    stat_summary(fun.y=mean, geom="point", shape=20, size=3, color="red", fill="red")

ggsave(file = "../../katdetectr_manusscript/figures/plotAlexandrovRuntimesTotallog10.jpeg", plotRunTimesTotallog10, width = 12, height = 4)
```

Venn diagram that shows in which samples one or more kataegis foci is detected by the packages
```{r}
katDetectadd <- resultsPerSample |> 
    filter(package == "katdetectr" & (TP | FP)) |> 
    pull(sampleNames)

clusteredMutationsadd <- resultsPerSample |> 
    filter(package == "ClusteredMutations" & (TP | FP)) |> 
    pull(sampleNames)

mafToolsadd <- resultsPerSample |> 
    filter(package == "MafTools" & (TP | FP)) |> 
    pull(sampleNames)

kataegisadd <- resultsPerSample |> 
    filter(package == "kataegis" & (TP | FP)) |> 
    pull(sampleNames)

seqkatadd <- resultsPerSample |> 
    filter(package == "SeqKat" & (TP | FP)) |> 
    pull(sampleNames)

sigProfilerClustersadd <- resultsPerSample |> 
    filter(package == "SigProfilerClusters" & (TP | FP)) |> 
    pull(sampleNames)

alexandrovAdd <- resultsPerSample |> 
    filter(kataegisInSample) |> 
    pull(sampleNames)

VennDiagram::venn.diagram(
    x = list(katDetectadd, clusteredMutationsadd, mafToolsadd, alexandrovAdd, sigProfilerClustersadd),
    category.names = c("Katdetectr", "ClusteredMutations", "MafTools", "Alexandrov", "SigProfilerClusters"),
    filename = "../figures/venn_diagram_kataegis_samples.png",
    output=T,
    imagetype="png",
    disable.logging = TRUE,
    
    cat.pos = c(0, 0, -120, 120, 0),
    fill = c("dodgerblue", "goldenrod1", "darkorange1", "seagreen3", "orchid3"),
    alpha = 0.50,
    col = "black",
    rotation.degree	= -6
)
```


```{r}
findOverlappingFoci <- function(x){
    
    allFociInSample <- x
    
    Focireduced <- allFociInSample %>% 
        GenomicRanges::makeGRangesFromDataFrame(keep.extra.columns = TRUE) %>% 
        GenomicRanges::reduce(min.gapwidth = 0, ignore.strand = TRUE, with.revmap = TRUE)
    
    names(Focireduced$revmap) <- paste0(unique(allFociInSample$sampleNames), "_foci_", seq(length(Focireduced$revmap)))
    
    fociList <- lapply(Focireduced$revmap, function(i){
        allFociInSample$package[i]
    })
    
    focidf <- lapply(seq_len(length(fociList)), function(i){
        tibble(package = fociList[[i]], foci = names(fociList)[i])
    }) %>% bind_rows()
    
    return(focidf)
}

alexKataegis <- alexandrovData$reportedKataegisFoci |> 
    as_tibble() |> 
    mutate(package = "Alexandrov")

resultsAlexPerFoci <- resultsAlex |> 
    filter(detectedKataegisInSample) |>  
    bind_rows(alexKataegis) |> 
    group_by(sampleNames) %>% 
    group_modify(~ findOverlappingFoci(.x), keep = TRUE) %>% 
    ungroup()

katdetectrFoci <- resultsAlexPerFoci |> 
    filter(package == "katdetectr") |> 
    pull(foci)

clusteredMutationsFoci <- resultsAlexPerFoci |> 
    filter(package == "ClusteredMutations") |> 
    pull(foci)

maftoolsFoci <- resultsAlexPerFoci |> 
    filter(package == "MafTools") |> 
    pull(foci)

kataegisPFoci <- resultsAlexPerFoci |> 
    filter(package == "kataegis") |> 
    pull(foci)

seqKatFoci <- resultsAlexPerFoci |> 
    filter(package == "SeqKat") |> 
    pull(foci)

sigProfilerClustersFoci <- resultsAlexPerFoci |> 
    filter(package == "SigProfilerClusters") |> 
    pull(foci)

alexandrovFoci <- resultsAlexPerFoci |> 
    filter(package == "Alexandrov") |> 
    pull(foci)


VennDiagram::venn.diagram(
    x = list(katdetectrFoci, clusteredMutationsFoci, maftoolsFoci, sigProfilerClustersFoci, alexandrovFoci),
    category.names = c("Katdetectr", "ClusteredMutations", "MafTools", "SigProfilerClusters", "Alexandrov"),
    filename = "../figures/testvenn.png",
    output=T,
    imagetype="png",
    disable.logging = TRUE,
    
    cat.pos = c(0, 0, -120, 120, 0),
    fill = c("dodgerblue", "goldenrod1", "darkorange1", "seagreen3", "orchid3"),
    alpha = 0.50,
    col = "black",
    rotation.degree	= -6
)
```



```{r}
resultsPerVariant |> 
    #filter(TMBcat == "high") |> 
    filter(package == "SigProfilerClusters") |> 
    arrange(-FP)

resultsPerVariant |> 
    filter(sampleNames == "PD4103a") 
```

```{r}
kd <- katdetectr::detectKataegis(alexandrovData$genomicVariants$PD7409a)

kd
kd@kataegisFoci 
katdetectr::rainfallPlot(kd)
```


```{r}
modelSampleRate <- function(IMDs){
    
    lambda <- log(2) / median(IMDs)
    
    return(lambda)
}

nthroot = function(x, n){
    
    y <- x^(1 / n)
    
    return(y)
}

determineIMDcutoff <- function(IMDs, totalVariants, width){
    
    sampleRate <- modelSampleRate(IMDs)
    
    IMDthreshold <- -log(1 - nthroot(0.01 / width, totalVariants - 1)) / sampleRate
    
    IMDthreshold <- replace(IMDthreshold, IMDthreshold > 1000, 1000)
    
    return(IMDthreshold)
}


kataegisFoci2 <-  kd@segments |> 
    as_tibble() |> 
    mutate(
        IMDcutoff = determineIMDcutoff(kd@genomicVariants$IMD, totalVariants, width)
    ) |> 
    filter(meanIMD < IMDcutoff & totalVariants >= 6) |> 
    determineKataegisFoci(genomicVariantsAnnotated = kd@genomicVariants)

kd2 <- katdetectr::constructKatdetect(
    genomicVariants = kd@genomicVariants, 
    segments = kd@segments, 
    kd@kataegisFoci
    
)

katdetectr::rainfallPlot(kd)
katdetectr::rainfallPlot(kd2)
```

```{r}
kd@kataegisFoci
```


```{r}
kd@segments |> 
    as_tibble() |> 
    mutate(
        IMDcutoff = determineIMDcutoff(kd@genomicVariants$IMD, totalVariants, width)
    ) |> 
    filter(meanIMD < IMDcutoff & totalVariants >= 6) |> 
    determineKataegisFoci(genomicVariantsAnnotated = kd@genomicVariants)
```

```{r}
determineKataegisFoci <- function(kataegisSegments, genomicVariantsAnnotated){
    
    kataegisSegments |> 
        .mergeKataegisSegments() |> 
        .annotateKataegisSegments(genomicVariantsAnnotated)
    
}

.determinefociID <- function(segmentIDs){
    
    nFoci <- base::sum(c(1, base::diff(segmentIDs)) != 1) + 1
    nSegmentsInFoci <- base::diff(c(1, base::which(c(1, base::diff(segmentIDs)) != 1), base::length(segmentIDs) + 1))
    fociID <- base::rep(base::seq_len(nFoci), nSegmentsInFoci)
    
    return(fociID)
}

.mergeKataegisSegments <- function(kataegisSegments){
    
    # when no kataegis foci are present in the segments
    if(base::nrow(kataegisSegments) == 0){
        kataegisFoci <- tibble::tibble()
    } else {
        kataegisFoci <- kataegisSegments |>
            dplyr::mutate(
                fociID = .determinefociID(.data$segmentID)
            ) |>
            dplyr::group_by(.data$seqnames, .data$fociID) |>
            dplyr::summarise(
                .groups = "keep",
                seqnames = base::unique(.data$seqnames),
                start = base::min(.data$start),
                end = base::max(.data$end),
                sampleNames = base::unique(.data$sampleNames),
                totalVariants = base::sum(.data$totalVariants),
                firstVariantID = base::min(.data$firstVariantID),
                lastVariantID = base::max(.data$lastVariantID),
                meanIMD = base::mean(.data$meanIMD)
            ) |>
            dplyr::ungroup()
    }
    
    return(kataegisFoci)
}

.annotateKataegisSegments <- function(kataegisFoci, genomicVariantsAnnotated){
    
    # when still no kataegis foci are detected after merging of segments
    if(base::nrow(kataegisFoci) == 0){
        kataegisFociAnnotated <- GenomicRanges::GRanges()
    }else{
        kataegisFociAnnotated <- kataegisFoci |>
            # remove old fociID
            dplyr::select(!.data$fociID) |>
            # add new correct fociID number based on rowindex
            tibble::rowid_to_column("fociID") |>
            dplyr::rowwise() |>
            # manually add the last variants to the detected kataegis foci
            dplyr::mutate(
                firstVariantOfSeqname = base::min(genomicVariantsAnnotated$variantID[as.logical(GenomicRanges::seqnames(genomicVariantsAnnotated) == .data$seqnames)]),
                firstVariantID = base::ifelse(.data$firstVariantID != .data$firstVariantOfSeqname, .data$firstVariantID - 1, .data$firstVariantID),
                totalVariants = .data$lastVariantID - .data$firstVariantID + 1
            ) |>
            dplyr::ungroup() |>
            dplyr::select(!.data$firstVariantOfSeqname) |>
            # update start of kataegis foci and add column with sample name
            dplyr::mutate(
                start = GenomicRanges::start(genomicVariantsAnnotated[.data$firstVariantID])
            ) |>
            # convert to granges
            GenomicRanges::makeGRangesFromDataFrame(keep.extra.columns = TRUE)
    }
    
    return(kataegisFociAnnotated)
}
```


```{r}
kd@segments |> 
    as_tibble() |> 
    #rowwise() |> 
    mutate(
        sampleRate = modelSampleRate(kd@genomicVariants$IMD),
        IMDcutoff = determineIMDcutoff(sampleRate, totalVariants, width)
    ) |> 
    filter(meanIMD < IMDcutoff & totalVariants >= 3) 
```


```{r}
kd@kataegisFoci

resultsAlex |> 
    filter(sampleNames == "PD4103a") |> 
    filter(package == "katdetectr")
```

